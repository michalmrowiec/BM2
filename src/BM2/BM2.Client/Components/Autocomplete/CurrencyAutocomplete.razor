@using BM2.Shared.DTOs
@using Newtonsoft.Json
@inject IApiOperator ApiOperator

<MudAutocomplete T="CurrencyDTO"
                 ValueChanged="@(async (c) => await SelectedCurrency.InvokeAsync(c))"
                 SearchFunc="Search"
                 Label="@Label"
                 ToStringFunc="@((c) => CurrencyDisplay(c))"
                 Clearable
                 MaxItems="1000"/>

@code {
    [Parameter] public string Label { get; set; } = "Currency";
    [Parameter] public EventCallback<CurrencyDTO> SelectedCurrency { get; set; }
    private IEnumerable<CurrencyDTO> _currencies = [];
    
    protected override async Task OnInitializedAsync()
    {
        var response = await ApiOperator.Get(@"api/v1/currencies");
        var r = await response.Content.ReadAsStringAsync();
        var crs = JsonConvert.DeserializeObject<List<CurrencyDTO>>(r) ?? new List<CurrencyDTO>();
        _currencies = crs.OrderBy(x => x.Name);
        StateHasChanged();
    }

    private async Task<IEnumerable<CurrencyDTO>> Search(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return _currencies;

        return _currencies.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase) || x.Symbol.Contains(value, StringComparison.InvariantCultureIgnoreCase) || x.IsoCode.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private string CurrencyDisplay(CurrencyDTO? currencyId)
    {
        if (currencyId == null)
            return string.Empty;

        //await SelectedCurrency.InvokeAsync(currencyId);
        //_model.DefaultCurrencyId = currencyId.Id;

        return $"[{currencyId.IsoCode}] {currencyId.Name}";
    }

}